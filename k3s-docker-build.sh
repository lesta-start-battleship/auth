#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
if [ -z "$1" ]; then
  echo "‚ùå –£–∫–∞–∂–∏ –∏–º—è –æ–±—Ä–∞–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: my-app:latest)"
  echo "–ü—Ä–∏–º–µ—Ä: ./k3s-docker-build.sh my-app:latest"
  exit 1
fi

IMAGE_NAME="$1"
TAR_NAME="${IMAGE_NAME//[:\/]/_}.tar"  # –∑–∞–º–µ–Ω—è–µ—Ç / –∏ : —á—Ç–æ–±—ã –∏–º—è —Ñ–∞–π–ª–∞ –±—ã–ª–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º

echo "üì¶ –ë–∏–ª–¥–∏–º Docker-–æ–±—Ä–∞–∑: $IMAGE_NAME"
docker build -t "$IMAGE_NAME" .

if [ $? -ne 0 ]; then
  echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏"
  exit 1
fi

echo "üìÇ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª: $TAR_NAME"
docker save "$IMAGE_NAME" -o "$TAR_NAME"

if [ $? -ne 0 ]; then
  echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"
  exit 1
fi

echo "üì• –ò–º–ø–æ—Ä—Ç –≤ k3s —á–µ—Ä–µ–∑ containerd"
sudo k3s ctr images import "$TAR_NAME"

if [ $? -ne 0 ]; then
  echo "‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞"
  exit 1
fi

echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –û–±—Ä–∞–∑ '$IMAGE_NAME' –¥–æ—Å—Ç—É–ø–µ–Ω –≤–Ω—É—Ç—Ä–∏ k3s"
